# Otoware-V2
「**音割れマイスター V2**（旧名：音割戦隊ウルセンジャー - ピークレッドV2）」とは、入力した音源のラウドネスを最大化するよう音割れさせるプログラム、およびアプリケーションです  
**本アプリの使用にはFFmpegのインストールが必須です**、各自でインストールをお願いいたします  
（ググれば方法が出てきます、下にもwindowsのリンクを貼っています）  
このアプリ関係なしにFFmpegは超有能なのでインストールしましょう  
　  
**「とにかくクソうるさい音源を作りたいっ！！！」**  
　  
そんなアホみたいな好奇心から全てが始まりました  
あるときはCubaseを使ってクリッパーを最大出力で何個も連結させたり、  
またある時はReaperを使ってOutput+20dBしてあるEQを何千個もインサートしたり、  
気づけばPythonでコードを書き始め、  
ついにはデスクトップアプリにまで漕ぎ着けました  
　  
本アプリは過去の実験の集大成  
**最高品質の音割れ音源**をご提供いたします  
　  
**音割れマイスター_V2.exe**  
**https://drive.google.com/open?id=1oEiUVOq8dzelSaSOXl51mutTOs3dW_cG**  
　  
**FFmpeg**  
**https://www.ffmpeg.org/**  
　  
**【windows】FFmpegをインストールする手順｜新卒エンジニアの開発日記**  
**https://fukatsu.tech/windows-ffmpeg**  
　  
　  
![音割れGUI](https://raw.githubusercontent.com/ippee/Otoware-V2/master/Picture/%E9%9F%B3%E5%89%B2%E3%82%8CGUI.jpg)

![音割れplot](https://raw.githubusercontent.com/ippee/Otoware-V2/master/Picture/%E9%9F%B3%E5%89%B2%E3%82%8Cplot.jpg)

　  
　  
## 注意事項
<font color="red">**音割れ音源は耳だけでなく、再生機材にもダメージを与える危険があります  
このアプリを使っていかなる損害が発生したとしても、私は一切の責任を負いかねます**</font>  
耳とか再生機材は大切にね  
　  
　  
## アプリの使い方
１、**音割れマイスター.exe** を起動（時間がかかります）  
２、出力設定で、**サンプリングレート**と**ビット深度**を決める  
　　・サンプリングレートを上げるとほんのちょっとだけ音圧が上がります  
　　・ビット深度については、音圧を限界まで上げるなら16bit、原曲の雰囲気を残すなら24bitをオススメします    
３、**クイックスキャン**を有効にするかを決める  
　　・通常の約半分の時間で計測しますが、正確さが少し落ちます  
４、**ラウドネスの推移をグラフで表示**するかどうかを決める  
５、最大で何dBFS音量を上げるか決める  
　　・大きくするほど処理に時間がかかります  
６、**音源を最適化** をクリックして、音割れさせるファイルを選択  
７、処理が終了するまで待機  
８、終了すると音声が出力されます  
　　・メッセージボックスがラウドネスに関係する情報付きで鳴ります  
　　・「ラウドネスの推移を表示」にチェックを入れていればグラフが表示されます  
　  
### 使う上での注意
- 音声処理の都合上、本アプリはコンソールの表示が有効になっています  
アプリ起動中にコンソールを閉じるとアプリも終了しますのでご注意ください
- 音声処理の途中、「srcWav.wav」「processing.wav」という２つのファイルを生成します  
前者は選択された音声ファイルを、一度.wavに変換してから処理に用いるためのファイルです  
後者は音声処理の途中経過ファイルです  
アプリのフリーズ等で音声処理が中断された場合、この２つが削除されない場合があります  
アプリを再起動すれば、これらのファイルは削除されます  
手動で消しても問題ありません
　  
　  
## V1と何が違うの？
### 音声処理をFFmpegのコマンドから実行  
V1ではpydubを使用していましたが、pydubで音量操作をした場合、ある一定ラインまで達すると音量が上げることが出来ませんでした  
V2ではsubprocessからFFmpegのコマンドを実行することでこの問題が解決し、本当の意味でのラウドネス最大化が可能になりました  
この問題の解決に伴い、<u>V1よりラウドネスをさらに高くできるようになりました</u>
　  
### GUIの作成
GUI付けた方が私個人としては扱いやすいのでつけました
　  
### ハイレゾ対応  
FFmpegのコマンドでハイレゾ音源を作れるようになったのでつけました  
（音割れハイレゾ音源とは）
　  
　  
## 32/64 bit floatについて
bit float音源の特徴の１つに、**0dBFSを越えても音割れしない**というものがあります  
（音割れしない理由は一番下の備忘録にて）  
「音割れしないのに何で実装してるの？」と思う人がいるかもしれませんが、ちゃんと理由があります
　  
### 理由：16/24bit intへの変換時による音割れ
bit float音源はよほどのことがない限り音割れしません（厳密には違う、備忘録で後述）  
が、それはbit floatという保存形式だからこそ可能なのであって、それが崩れてしまえば音割れするよねってという話です  
　  
まず前提として、世の中には "32bit float DAC" というものは存在しないので、bit float音源をそのままの形式で再生することは出来ません  
（DACとは、デジタル信号をアナログ信号に変換する装置のこと）  
（32bit "int" DACは存在するようですが、現状世の中に存在する大半のDACは16/24bit int DACです）  
そのためbit float音源を再生する場合、DACに入る前のどっかのタイミングで16/24bit intに変換されます  
この変換時のbit floatが崩れる瞬間を狙うのが、bit float音源の出力に対応させている理由です
　  
### 補足：メディアプレイヤーによるbit float音源の扱いの違い
と、いうものの  
使用するメディアプレイヤーによっては、こうしたクソデカ信号音源をうまく再生できない場合があります  
　    
例えば、Windows Media PlayerやVLCメディアプレイヤーでは、0dBFSを越えた分はノーマライズされて再生されます  
（ただし+43～+45dB辺りを越えると再生されない）  
　  
一方、Audacity（メディアプレイヤー……？）に取り込むと、音割れした状態で再生されます  
（恐らく出力時に24bit intに変換されています）  
私は試していませんが、iTunesでも音割れするそうです  
参考: https://av.watch.impress.co.jp/docs/series/dal/624971.html  
　  
　  
## その他（補足など）
- 作業環境  
  - Windows 10
  - Python 3.6.4
- Pythonで動かしているので、基本的に挙動は遅いです  
起動ものっそりとしていますが、気長に待ってやってください  
- 「動けばなんでもいいだろ精神」で作っているので、コードの見やすさとか全く考えてないです()  
見にくかったらごめんなさい  
見やすいコードを書けるようになったら改訂する<u>かも</u>しれません  

## 更新履歴
- 2020/02/10: クイックスキャン機能の追加（V2.3）
- 2020/02/08: スペースが含まれるファイル名を読み込んだ時のバグを解消（V2.2）
- 2020/02/08: アプリ名変更、FFmpegコマンドの実行をffmpyからsubprocessに変更（V2.1）
- 2020/02/02: 本アプリ作成（V2.0）
　  
　  
***
　  
## 備忘録：デジタルにおける音割れの限界
音割れ実験をしているとき、私は常に思っていました  
**「いくらbit float音源が0dBFSを越えても音割れしないと言っても、限界くらいあるでしょ？」**  
　  
だって、例えば32bit floatで表せる数値の範囲って  
0.00000000000000000000000000000000000000000000140239846 ～ 340,282,347,000,000,000,000,000,000,000,000,000,000 (10)  
と、確かに超ちっこい数からクソデカい数値まで扱えますが、それでも扱える数値に限りがあるんです  
　  
ということはですよ。  
**とりあえずボリュームを+100,000dBとかクソデカい数字を入れておけば、32bit float音源と言えども音割れすんじゃね？！？！？！　フォオオオ～ッ♪**  
　  
と、思ってやってみたんですが……  
　  
最初はCubaseのクリッパーを使って音源の音量をガンガン上げて音割れさせていたんですが、途中から音が出なくなるという現象が発生しました  
（画像はCubaseの限界一歩手前、右下のプラグインはスペアナです）  

![音割れCubase](https://raw.githubusercontent.com/ippee/Otoware-V2/master/Picture/%E9%9F%B3%E5%89%B2%E3%82%8CCubase.jpg)

また、本アプリを使っていくらゲインを高くしても、アプリの示すラウドネスが最大となるポイントは+770dBが限界で、この数値以降のラウドネスの推移もカットされ表示されませんでした  
（画像は+1000dB下結果です）  

![音割れメッセージ](https://raw.githubusercontent.com/ippee/Otoware-V2/master/Picture/%E9%9F%B3%E5%89%B2%E3%82%8C%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8.jpg)

![音割れplot線形](https://raw.githubusercontent.com/ippee/Otoware-V2/master/Picture/%E9%9F%B3%E5%89%B2%E3%82%8Cplot%E7%B7%9A%E5%BD%A2.jpg)

+770dBで止まるなら、+771dBで書き出したらどうなるんだろうと思い、出力して再生してみたところ、  
**ま　さ　か　の　無　音**  
Audacityで波形を見たら変に表示されてるし   

![音割れ波形](https://user-images.githubusercontent.com/29997720/74097557-8e97c780-4b50-11ea-969b-c036e7101eb2.jpg)

bit float音源は0dBFSを越えても波形は潰れず残っているはずので、0dBFSでノーマライズしてみようと思い増幅をクリック、すると……  

![メッセージ](https://user-images.githubusercontent.com/29997720/74097563-abcc9600-4b50-11ea-97c8-30577ab7012c.jpg)

　  
**Infinity?**  
　  
この時点でピーンと来ました  
当時bit floatの数値の表現方法についてあまり詳しくなかったのですが、無限大を表現できるというのは聞いたことがありました  
　  
詳しく調べてみると、bit floatの数値表現は、「符号部（1bit）・指数部（8bit）・仮数部（23bit）」の３つから成っており、このうち指数部の数値が全て１になると **Infinity（無限大）** という特別な意味を持つものに変わるということが分かりました  
このせいで振幅がInfinityと認識され、音源の再生自体が不可能になるようです  
　  
なぜ+770dBで止まるのか？  
それは32bit float音源の表現可能な音量の範囲と関係があります  
32bit float音源で扱える最小音と最大音は、  
Min ＝ -758 dBFS  
Max ＝  770 dBFS（普通は0dBFS、けどbit float音源はその上も扱えるから音割れしない）  
となっており、-758 dFFSを下回るものは-∞（無音）、770 dBFSを上回るものは∞（振幅が無限）となるためです  
　  
ここまで調べてようやく理解、結論へ  
　  
<font size=6>**bit float音源の限界 = Infinity（再生不可）**</font>  
　  
　  
### 最後にひとこと
**理解はしたが納得はしてないからな**  
　／|＿＿＿＿＿＿＿＿＿ _ _  
〈　 To Be Continued…　////  
　＼|￣￣￣￣￣￣￣￣~ ~ ￣  
　  
　  
### 参考
- 実数の表現 | 情報の表現
  - http://ss.sguc.ac.jp/~rider/basic/float.html
- ビット・レートとバス幅 | Studio Gyokimae
  - https://pspunch.com/pd/article/bit_depth/
- 32-bit Float セッション、音源の理解は非常に難しい。 | NK PRODUCTIONS
  - https://nk-productions.net/daw/do-not-understand-32-bit-float/
- 32-Bit Float Files Explained | SOUND DEVICES
  - https://www.sounddevices.com/32-bit-float-files-explained/
